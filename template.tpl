___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": [
    "CONVERSIONS"
  ],
  "displayName": "trivago Conversion API",
  "brand": {
    "id": "github.com_trivago",
    "displayName": "trivago",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Implementation of the trivago conversion API solution",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "key",
    "displayName": "api_key",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Key provided by trivago, valid for 1 year,",
    "valueHint": "e.g. bf5bea...f4a339b"
  },
  {
    "type": "TEXT",
    "name": "advertiserId",
    "displayName": "advertiser_id",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The unique partner id provided by trivago",
    "valueHint": "e.g. 329"
  },
  {
    "type": "GROUP",
    "name": "parameters",
    "displayName": "Booking parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "trvReference",
        "displayName": "trv_reference",
        "simpleValueType": true,
        "help": "Unique tracking parameter as provided at the end of the deep-link. At express, this will be passed in tracking_data object in booking submit request."
      },
      {
        "type": "TEXT",
        "name": "hotel",
        "displayName": "hotel",
        "simpleValueType": true,
        "help": "The advertiser\u0027s unique hotel ID. Must be identical to the IDs used in the inventory feed"
      },
      {
        "type": "TEXT",
        "name": "arrival",
        "displayName": "arrival",
        "simpleValueType": true,
        "help": "Arrival date (UNIX timestamp, e.g. 1524566908)"
      },
      {
        "type": "TEXT",
        "name": "departure",
        "displayName": "departure",
        "simpleValueType": true,
        "help": "Departure date (UNIX timestamp, e.g. 1524739708)"
      },
      {
        "type": "TEXT",
        "name": "dateFormat",
        "displayName": "date_format",
        "simpleValueType": true,
        "help": "If arrival and departure cannot be given in UNIX timestamp format, they can be given in a different format (e.g. 20181025 - Ymd). In this case, the date_format parameter has to be provided."
      },
      {
        "type": "TEXT",
        "name": "bookingDate",
        "displayName": "booking_date",
        "simpleValueType": true,
        "help": "Booking submit date (UNIX timestamp, e.g. 1524566500)"
      },
      {
        "type": "TEXT",
        "name": "bookingDateFormat",
        "displayName": "booking_date_format",
        "simpleValueType": true,
        "help": "If booking_date cannot be given in UNIX timestamp format, it can be given in a different format. In this case, the booking_date_format parameter has to be provided."
      },
      {
        "type": "TEXT",
        "name": "volume",
        "displayName": "volume",
        "simpleValueType": true,
        "help": "Total booking price per stay (including all rooms, all nights, all taxes)."
      },
      {
        "type": "TEXT",
        "name": "currency",
        "displayName": "currency",
        "simpleValueType": true,
        "help": "Currency in ISO 4217 code"
      },
      {
        "type": "TEXT",
        "name": "bookingId",
        "displayName": "booking_id",
        "simpleValueType": true,
        "help": "The advertiser\u0027s booking reference. For tEB, must be same as the reservation_id from the booking_submit response."
      },
      {
        "type": "TEXT",
        "name": "locale",
        "displayName": "locale",
        "simpleValueType": true,
        "help": "Contains the trivago POS from which the visitor was linked through to the advertiser\u0027s site. Format is always the 2-letter top level domain of that country."
      },
      {
        "type": "TEXT",
        "name": "margin",
        "displayName": "margin",
        "simpleValueType": true,
        "help": "Percentage which is received from the booking amount of the hotel as commission for the booking (in this sample case 15.8%)."
      },
      {
        "type": "TEXT",
        "name": "marginAbsolute",
        "displayName": "margin_absolute",
        "simpleValueType": true,
        "help": "In case the margin cannot be provided in percentage, it can be provided alternatively as absolute value (in this example 60.30 USD). Please note that the currency of margin_absolute should match the currency provided for the volume."
      },
      {
        "type": "TEXT",
        "name": "channel",
        "displayName": "channel",
        "simpleValueType": true,
        "help": "In case of tEB advertisers, the param is mandatory. If the booking was done via tEB, the channel\u0027s value should be \"tebadv\". Alternatively, the value should be \"lpadv\".The parameter cannot be left empty."
      },
      {
        "type": "CHECKBOX",
        "name": "refundConfirmation",
        "checkboxText": "Configure this tag for refund request",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "refundAmount",
        "displayName": "refund_amount. Fill only if the Tag is configured for the cancelation event.",
        "simpleValueType": true,
        "help": "Total refunded price per stay (including all rooms, all nights, all taxes)."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const query = require('queryPermission');      
const log = require('logToConsole');
const copyFromWindow = require('copyFromWindow');

const url ="https://conv.trivago.com/trv_conversion_api.js";
const key_name = 'GTM_TRV_REFERENCE_TR';

const trv_ref_window_object = copyFromWindow(key_name);

const TRV = {};
TRV.Tag = {};

TRV.Tag.key = data.key;
TRV.Tag.advertiser_id = data.advertiserId;
TRV.Tag.trv_reference = trv_ref_window_object || data.trvReference;
TRV.Tag.hotel = data.hotel;
TRV.Tag.arrival = data.arrival;
TRV.Tag.departure = data.departure;
TRV.Tag.date_format = data.dateFormat;
TRV.Tag.booking_date = data.bookingDate;
TRV.Tag.booking_date_format = data.bookingDateFormat;
TRV.Tag.volume = data.volume;
TRV.Tag.currency = data.currency;
TRV.Tag.booking_id = data.bookingId;
TRV.Tag.locale = data.locale;
TRV.Tag.margin = data.margin;
TRV.Tag.margin_absolute = data.marginAbsolute;
TRV.Tag.refund_amount = data.refundAmount;
TRV.Tag.channel = data.channel;
TRV.Tag.refund_confirmation = data.refundConfirmation;

setInWindow('TRV', TRV, true);
setInWindow('DATA_TRV', data, true);


const onSuccess = () => {
  	log('script was loaded');
};

const onFailure = () => {
  	log("Error: failed to trigger event on url: " + url + " with data: " + data);
    data.gtmOnFailure();
};

if (query('inject_script', url)) {
  injectScript(url, onSuccess, onFailure);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "TRV"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "DATA_TRV"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "GTM_TRV_REFERENCE_TR"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://conv.trivago.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 02/12/2019, 17:11:27


