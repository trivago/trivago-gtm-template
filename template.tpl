___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "categories": ["CONVERSIONS"],
  "displayName": "trivago Conversion API",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Implementation of trivago Conversion API as a frontend solution for booking confirmations.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "api_key",
    "displayName": "api_key",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Secret API key provided by trivago which is valid for 1 year"
  },
  {
    "type": "TEXT",
    "name": "advertiser_id",
    "displayName": "advertiser_id",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NUMBER"
      }
    ],
    "help": "The unique partner id provided by trivago"
  },
  {
    "type": "TEXT",
    "name": "trv_reference",
    "displayName": "trv_reference",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "The unique identifier which is passed from trivago with each click out on your platform. Usually passed as a URL parameter trv_reference."
  },
  {
    "type": "TEXT",
    "name": "hotel",
    "displayName": "hotel",
    "simpleValueType": true,
    "help": "Unique partner reference for property"
  },
  {
    "type": "TEXT",
    "name": "arrival",
    "displayName": "arrival",
    "simpleValueType": true,
    "help": "Arrival date UNIX timestamp (e.g. 1524566908)"
  },
  {
    "type": "TEXT",
    "name": "departure",
    "displayName": "departure",
    "simpleValueType": true,
    "help": "Departure date UNIX timestamp (e.g. 1524566908)"
  },
  {
    "type": "TEXT",
    "name": "date_format",
    "displayName": "date_format",
    "simpleValueType": true,
    "help": "If arrival and departure cannot be given in UNIX timestamp format, they can be given in a different format (e.g. 20181025 - Ymd). In this case, the date_format parameter has to be provided."
  },
  {
    "type": "TEXT",
    "name": "booking_date",
    "displayName": "booking_date",
    "simpleValueType": true,
    "help": "Booking submit date (UNIX timestamp, e.g. 1524566500)"
  },
  {
    "type": "TEXT",
    "name": "booking_date_format",
    "displayName": "booking_date_format",
    "simpleValueType": true,
    "help": "If booking_date cannot be given in UNIX timestamp format, it can be given in a different format. In this case, the booking_date_format parameter has to be provided. Please also include the time of the booking in seconds (e.g. 20201025173002). The recommended format is YmdHis but the separator can be adjusted as desired according to the PHP documentation."
  },
  {
    "type": "TEXT",
    "name": "volume",
    "displayName": "volume",
    "simpleValueType": true,
    "help": "Total booking price per stay (including all rooms, all nights, all taxes)."
  },
  {
    "type": "TEXT",
    "name": "currency",
    "displayName": "currency",
    "simpleValueType": true,
    "help": "Currency in ISO 4217 code."
  },
  {
    "type": "TEXT",
    "name": "booking_id",
    "displayName": "booking_id",
    "simpleValueType": true,
    "help": "The advertiser\u0027s booking reference. For tEB, must be same as the reservation_id from the booking_submit response."
  },
  {
    "type": "TEXT",
    "name": "locale",
    "displayName": "locale",
    "simpleValueType": true,
    "help": "Contains the trivago POS from which the visitor was linked through to the advertiser\u0027s site. Format is always the 2-letter top level domain of that country."
  },
  {
    "type": "TEXT",
    "name": "margin",
    "displayName": "margin",
    "simpleValueType": true,
    "help": "Percentage which is received from the booking amount of the hotel as commission for the booking (in this sample case 15.8%)."
  },
  {
    "type": "TEXT",
    "name": "margin_absolute",
    "displayName": "margin_absolute",
    "simpleValueType": true,
    "help": "In case the margin cannot be provided in percentage, it can be provided alternatively as absolute value (in this example 60.30 USD). Please note that the currency of margin_absolute should match the currency provided for the volume."
  },
  {
    "type": "TEXT",
    "name": "refund_amount",
    "displayName": "refund_amount",
    "simpleValueType": true,
    "help": "Total refunded price per stay (including all rooms, all nights, all taxes)."
  },
  {
    "type": "TEXT",
    "name": "channel",
    "displayName": "channel",
    "simpleValueType": true,
    "help": "In case of tEB advertisers, the param is mandatory. If the booking was done via tEB, the channel\u0027s value should be \"tebadv\". Alternatively, the value should be \"lpadv\".The parameter cannot be left empty."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');
const encodeUriComponent = require('encodeUriComponent');
const query = require('queryPermission');

const log = require('logToConsole');
const url ="https://conv.trivago.com/trv_conversion_api.js";

const TRV = {};
TRV.Tag = {};

TRV.Tag.api_key = data.api_key;
TRV.Tag.advertiser_id = data.advertiser_id;
TRV.Tag.trv_reference = data.trv_reference;
TRV.Tag.hotel = data.hotel;
TRV.Tag.arrival = data.arrival;
TRV.Tag.departure = data.departure;
TRV.Tag.date_format = data.date_format;
TRV.Tag.booking_date = data.booking_date;
TRV.Tag.booking_date_format = data.booking_date_format;
TRV.Tag.volume = data.volume;
TRV.Tag.currency = data.currency;
TRV.Tag.booking_id = data.booking_id;
TRV.Tag.locale = data.locale;
TRV.Tag.margin = data.margin;
TRV.Tag.margin_absolute = data.margin_absolute;
TRV.Tag.refund_amount = data.refund_amount;
TRV.Tag.channel = data.channel;

setInWindow('TRV', TRV, true);

const onSuccess = () => {
  	data.gtmOnSuccess();
};

const onFailure = () => {
  	log("Error: failed to trigger event on url: " + url + " with data: " + data);
    data.gtmOnFailure();
};

if (query('inject_script', url)) {
  injectScript(url, onSuccess, onFailure);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://conv.trivago.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "TRV"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Untitled test 1
  code: |-
    // Call runCode to run the template's code.
    runCode();

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 23/11/2019, 21:21:58


